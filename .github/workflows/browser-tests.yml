name: browser-tests

on:
  push:
    branches:
      - pest-ci
      - develop
      - main
  pull_request:
    branches:
      - pest-ci
      - develop
      - main

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5
          tools: composer:v2
          coverage: pcov

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.1.17

      - name: Configure Composer Auth
        env:
          FLUXUI_PRO_USERNAME: ${{ secrets.FLUXUI_PRO_USERNAME }}
          FLUXUI_PRO_KEY: ${{ secrets.FLUXUI_PRO_KEY }}
        run: |
          if [[ -n "$FLUXUI_PRO_USERNAME" && -n "$FLUXUI_PRO_KEY" ]]; then
            composer config http-basic.composer.fluxui.dev "$FLUXUI_PRO_USERNAME" "$FLUXUI_PRO_KEY"
          else
            echo "::warning::FLUXUI_PRO_USERNAME and FLUXUI_PRO_KEY secrets not set. Skipping Flux UI Pro authentication."
            echo "::warning::If composer install fails due to Flux UI Pro, add these secrets to the repository."
          fi

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Install Dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader
          bun install --frozen-lockfile

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Setup Test Environment
        run: |
          cp vendor/laravel-labs/starter-kit-browser-tests/phpunit.xml.dist .
          rm -f phpunit.xml
          rm -Rf tests/
          cp -rf vendor/laravel-labs/starter-kit-browser-tests/tests/ tests/
          # Add our CSP helper function to the copied Pest.php
          # First, add required imports if not present
          if ! grep -q "use Pest\\\\Browser\\\\Api\\\\AwaitableWebpage" tests/Pest.php; then
            sed -i '/^<?php/a use Pest\\Browser\\Api\\AwaitableWebpage;' tests/Pest.php
          fi
          if ! grep -q "use Pest\\\\Browser\\\\Api\\\\PendingAwaitablePage" tests/Pest.php; then
            sed -i '/^<?php/a use Pest\\Browser\\Api\\PendingAwaitablePage;' tests/Pest.php
          fi
          if ! grep -q "use Pest\\\\Browser\\\\Api\\\\Webpage" tests/Pest.php; then
            sed -i '/^<?php/a use Pest\\Browser\\Api\\Webpage;' tests/Pest.php
          fi
          if ! grep -q "use PHPUnit\\\\Framework\\\\AssertionFailedError" tests/Pest.php; then
            sed -i '/^<?php/a use PHPUnit\\Framework\\AssertionFailedError;' tests/Pest.php
          fi
          # Add the CSP helper function at the end of Pest.php
          cat >> tests/Pest.php << 'HELPER_EOF'

function assertNoJavaScriptErrorsExceptCspParser(PendingAwaitablePage|AwaitableWebpage|Webpage $page): PendingAwaitablePage|AwaitableWebpage|Webpage
{
    try {
        $page->assertNoJavaScriptErrors();
    } catch (Throwable $e) {
        // Only handle AssertionFailedError exceptions (use string to avoid internal-class errors).
        // Use string literal with is_a() to avoid PHPStan internal class warnings
        // Rector prefers throw_unless, which works fine with is_a() and string literals
        throw_unless(is_a($e, 'PHPUnit\Framework\AssertionFailedError'), $e);

        $message = $e->getMessage();

        // Check if the error contains CSP parser errors (various formats)
        // CSP parser errors can appear as:
        // - "CSP Parser Error: Unexpected token: input"
        // - "CSP Parser Error: Expected PUNCTUATION ":" but got PUNCTUATION "(""
        // - "Uncaught Error: CSP Parser Error: ..."
        // - In the main message: "but found 1: Uncaught Error: CSP Parser Error: ..."
        $isCspError = str_contains($message, 'CSP Parser Error') ||
            (bool) preg_match('/CSP.*Parser.*Error/i', $message);

        if ($isCspError) {
            // Extract all errors from the message
            // The message format can be:
            // 1. "Expected no JavaScript errors..., but found X:\n- Error 1\n- Error 2"
            // 2. "Expected no JavaScript errors..., but found 1: Uncaught Error: CSP Parser Error: ..."
            preg_match_all('/- (.+)/m', $message, $matches);
            /** @var list<non-empty-string> $errors */
            /** @phpstan-ignore-next-line */
            $errors = is_array($matches[1] ?? null) ? $matches[1] : [];

            // Also check the main message for CSP errors (format: "but found 1: Uncaught Error: CSP Parser Error: ...")
            $mainErrorIsCsp = false;
            if (preg_match('/but found \d+:\s*(.+?)(?:\n|$)/s', $message, $mainMatch) === 1) {
                /** @var array{0: non-falsy-string, 1: non-empty-string} $mainMatch */
                $mainError = $mainMatch[1];
                $mainErrorIsCsp = str_contains($mainError, 'CSP Parser Error') ||
                    (bool) preg_match('/CSP.*Parser.*Error/i', $mainError);
            }

            // If no errors were extracted from the list format, check if the main message contains only CSP errors
            if ($errors === [] && $mainErrorIsCsp) {
                // It's a CSP error in the main message, ignore it
                return $page;
            }

            // Filter out CSP parser errors (check for various CSP error patterns)
            $realErrors = array_filter($errors, function (string $error): bool {
                // Filter out all CSP parser errors - they contain "CSP Parser Error" or match CSP error patterns
                // Check both exact string match and regex pattern match
                $isCspErrorInList = str_contains($error, 'CSP Parser Error') ||
                    (bool) preg_match('/CSP.*Parser.*Error/i', $error);

                return ! $isCspErrorInList;
            });

            // If there are real errors, throw them
            if ($realErrors !== []) {
                /** @phpstan-ignore-next-line */
                throw new AssertionFailedError(
                    "Expected no JavaScript errors on the page, but found:\n".
                    implode("\n", array_map(fn (string $error): string => "- {$error}", $realErrors))
                );
            }

            // If only CSP parser errors (either in list or main message), ignore them (they're false positives)
            // If all errors were filtered out, it means they were all CSP errors
            return $page;
        }

        // Re-throw if it's not a CSP parser error
        throw $e;
    }

    return $page;
}
HELPER_EOF
          # Replace assertNoJavaScriptErrors() with assertNoJavaScriptErrorsExceptCspParser() in all test files
          find tests/ -name "*.php" -type f -exec sed -i.bak 's/->assertNoJavaScriptErrors()/->assertNoJavaScriptErrorsExceptCspParser()/g' {} \;
          find tests/ -name "*.bak" -type f -delete

      - name: Build Assets
        run: bun run build

      - name: Tests
        run: php vendor/bin/pest
