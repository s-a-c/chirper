name: browser-tests

on:
  push:
    branches:
      - pest-ci
      - develop
      - main
  pull_request:
    branches:
      - pest-ci
      - develop
      - main

permissions:
  contents: read

jobs:
  browser-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.5
          tools: composer:v2
          coverage: pcov

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.1.17

      - name: Configure Composer Auth
        env:
          FLUXUI_PRO_USERNAME: ${{ secrets.FLUXUI_PRO_USERNAME }}
          FLUXUI_PRO_KEY: ${{ secrets.FLUXUI_PRO_KEY }}
        run: |
          if [[ -n "$FLUXUI_PRO_USERNAME" && -n "$FLUXUI_PRO_KEY" ]]; then
            composer config http-basic.composer.fluxui.dev "$FLUXUI_PRO_USERNAME" "$FLUXUI_PRO_KEY"
          else
            echo "::warning::FLUXUI_PRO_USERNAME and FLUXUI_PRO_KEY secrets not set. Skipping Flux UI Pro authentication."
            echo "::warning::If composer install fails due to Flux UI Pro, add these secrets to the repository."
          fi

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Install Dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader
          bun install --frozen-lockfile

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Setup Test Environment
        run: |
          # Create separate directory for browser tests to avoid overwriting project files
          cp -rf vendor/laravel-labs/starter-kit-browser-tests/tests/ tests.starter-kit-browser/

          # Create separate phpunit.xml configuration for browser tests
          cp vendor/laravel-labs/starter-kit-browser-tests/phpunit.xml.dist phpunit.xml.starter-kit-browser

          # Update phpunit.xml.starter-kit-browser to use the separate tests directory
          sed -i.bak 's|<directory>tests/|<directory>tests.starter-kit-browser/|g' phpunit.xml.starter-kit-browser
          rm -f phpunit.xml.starter-kit-browser.bak

          # Remove APP_BASE_PATH requirement from TestCase (not needed for Laravel apps, only packages)
          TESTCASE_FILE="tests.starter-kit-browser/TestCase.php"
          if [ -f "$TESTCASE_FILE" ]; then
            # Remove the RequiresEnvironmentVariable attribute line
            sed -i.bak '/#\[RequiresEnvironmentVariable/d' "$TESTCASE_FILE"
            # Remove the use statement for RequiresEnvironmentVariable if it exists
            sed -i.bak '/use PHPUnit\\Framework\\Attributes\\RequiresEnvironmentVariable/d' "$TESTCASE_FILE"
            rm -f "$TESTCASE_FILE.bak"
          fi

          # Add our CSP helper function to the copied Pest.php
          # First, add required imports if not present (using a portable method)
          PEST_FILE="tests.starter-kit-browser/Pest.php"
          IMPORTS_NEEDED=false

          if ! grep -q "use Pest\\Browser\\Api\\AwaitableWebpage" "$PEST_FILE"; then
            IMPORTS_NEEDED=true
          fi
          if ! grep -q "use Pest\\Browser\\Api\\PendingAwaitablePage" "$PEST_FILE"; then
            IMPORTS_NEEDED=true
          fi
          if ! grep -q "use Pest\\Browser\\Api\\Webpage" "$PEST_FILE"; then
            IMPORTS_NEEDED=true
          fi
          if ! grep -q "use PHPUnit\\Framework\\AssertionFailedError" "$PEST_FILE"; then
            IMPORTS_NEEDED=true
          fi

          if [ "$IMPORTS_NEEDED" = "true" ]; then
            # Create temporary file with imports
            IMPORTS_TMP=$(mktemp)
            printf '%s\n' \
              'use Pest\Browser\Api\AwaitableWebpage;' \
              'use Pest\Browser\Api\PendingAwaitablePage;' \
              'use Pest\Browser\Api\Webpage;' \
              'use PHPUnit\Framework\AssertionFailedError;' > "$IMPORTS_TMP"

            # Insert imports after the opening PHP tag using awk
            awk -v imports_file="$IMPORTS_TMP" '
              /^<\?php/ {
                print
                while ((getline line < imports_file) > 0) {
                  print line
                }
                close(imports_file)
                next
              }
              { print }
            ' "$PEST_FILE" > "$PEST_FILE.tmp" && mv "$PEST_FILE.tmp" "$PEST_FILE"
            rm -f "$IMPORTS_TMP"
          fi

          # Add the CSP helper function at the end of Pest.php
          # Use a separate file to avoid YAML parsing issues with heredoc
          if [ -f scripts/browser-tests-helper.php ]; then
            # Extract just the function body (skip opening PHP tag if present)
            sed '1d' scripts/browser-tests-helper.php >> tests.starter-kit-browser/Pest.php
          else
            echo "Warning: scripts/browser-tests-helper.php not found, skipping CSP helper function"
          fi

          # Replace assertNoJavaScriptErrors() with assertNoJavaScriptErrorsExceptCspParser() in all test files
          find tests.starter-kit-browser/ -name "*.php" -type f -exec sed -i.bak 's/->assertNoJavaScriptErrors()/->assertNoJavaScriptErrorsExceptCspParser()/g' {} \;
          find tests.starter-kit-browser/ -name "*.bak" -type f -delete

      - name: Build Assets
        run: bun run build

      - name: Tests
        run: php vendor/bin/pest --configuration=phpunit.xml.starter-kit-browser
