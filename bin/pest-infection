#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Wrapper script for Infection to run Pest tests.
 * This script is called by Infection during mutation testing.
 * 
 * Infection passes arguments similar to PHPUnit:
 * - Test file path
 * - --filter option
 * - Other PHPUnit-compatible options
 */

$pestPath = __DIR__.'/../vendor/bin/pest';

// Get all arguments except the script name
$args = array_slice($argv, 1);

if (empty($args)) {
    fwrite(STDERR, "Error: No arguments provided\n");
    exit(1);
}

// Convert PHPUnit-style --filter to Pest format
$pestArgs = [];
foreach ($args as $arg) {
    // Convert --filter="testName" to Pest's filter format
    if (str_starts_with($arg, '--filter=')) {
        $filter = substr($arg, 9); // Remove '--filter='
        $filter = trim($filter, '"\'');
        $pestArgs[] = '--filter='.escapeshellarg($filter);
    } elseif ($arg === '--filter' && isset($args[array_search($arg, $args) + 1])) {
        // Handle --filter as separate argument
        $nextIndex = array_search($arg, $args) + 1;
        $filter = $args[$nextIndex] ?? '';
        $filter = trim($filter, '"\'');
        $pestArgs[] = '--filter='.escapeshellarg($filter);
        unset($args[$nextIndex]);
    } elseif (str_starts_with($arg, '--')) {
        // Pass through other PHPUnit-style options that Pest might understand
        $pestArgs[] = $arg;
    } else {
        // Test file path or other arguments
        $pestArgs[] = escapeshellarg($arg);
    }
}

// Build the command
$command = escapeshellarg($pestPath).' '.implode(' ', $pestArgs);

// Execute Pest and pass through exit code
passthru($command, $exitCode);
exit($exitCode);
